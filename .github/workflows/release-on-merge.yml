name: Publish Release (Self-contained single-file)

on:
  push:
    branches:
      - master

permissions:
  contents: write
  packages: write

jobs:
  build-and-test:
    name: Build & Test
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --configuration Release --no-build --logger "trx;LogFileName=test_results.trx"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/*.trx'

  publish-release:
    name: Publish self-contained single-file release (Windows)
    needs: build-and-test
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Publish single-file self-contained (win-x64)
        run: |
          dotnet publish MouseGuard.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true -o ./publish

      - name: List publish output
        run: dir ./publish

      - name: Zip the publish output
        run: |
          $resultZip = "MouseGuard-win-x64.zip"
          if(Test-Path $resultZip) { Remove-Item $resultZip -Force }
          Compress-Archive -Path ./publish/* -DestinationPath $resultZip
          Write-Output "Created $resultZip"

      - name: Create Release (if not present)
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          name: "MouseGuard v${{ github.run_number }}"
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: MouseGuard-win-x64.zip
          asset_name: MouseGuard-win-x64.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload ZIP artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: MouseGuard-win-x64
          path: MouseGuard-win-x64.zip